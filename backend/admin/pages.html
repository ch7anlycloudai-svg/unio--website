<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <p>Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø©</p>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            <a href="news.html" class="nav-item">
                <span class="nav-icon">ğŸ“°</span>
                <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
            </a>
            <a href="messages.html" class="nav-item">
                <span class="nav-icon">âœ‰ï¸</span>
                <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
            </a>
            <a href="pages.html" class="nav-item active">
                <span class="nav-icon">ğŸ“„</span>
                <span>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª</span>
            </a>
            <a href="media.html" class="nav-item">
                <span class="nav-icon">ğŸ–¼ï¸</span>
                <span>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="/" class="nav-item">
                <span class="nav-icon">ğŸŒ</span>
                <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span>
            </a>
            <button onclick="logout()" class="nav-item logout-btn">
                <span class="nav-icon">ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-title">
                <h1>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª</h1>
                <p>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø¬Ù…ÙŠØ¹ ØµÙØ­Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</p>
            </div>
        </header>

        <!-- Page Tabs -->
        <div class="page-tabs">
            <button class="page-tab active" onclick="selectPage('home')" data-page="home">
                <span>ğŸ </span> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </button>
            <button class="page-tab" onclick="selectPage('about')" data-page="about">
                <span>â„¹ï¸</span> Ù…Ù† Ù†Ø­Ù†
            </button>
            <button class="page-tab" onclick="selectPage('guide')" data-page="guide">
                <span>ğŸ“–</span> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
            </button>
            <button class="page-tab" onclick="selectPage('programs')" data-page="programs">
                <span>ğŸ“</span> Ø§Ù„ØªØ®ØµØµØ§Øª
            </button>
            <button class="page-tab" onclick="selectPage('services')" data-page="services">
                <span>ğŸ› ï¸</span> Ø§Ù„Ø®Ø¯Ù…Ø§Øª
            </button>
            <button class="page-tab" onclick="selectPage('contact')" data-page="contact">
                <span>ğŸ“</span> Ø§Ù„ØªÙˆØ§ØµÙ„
            </button>
        </div>

        <!-- Page Content Editor -->
        <div class="page-editor">
            <div class="editor-header">
                <h2 id="currentPageTitle">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                <div class="editor-actions">
                    <a id="previewLink" href="/" target="_blank" class="btn btn-secondary">
                        <span>ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙØ­Ø©
                    </a>
                    <button onclick="saveAllChanges()" class="btn btn-primary">
                        <span>ğŸ’¾</span> Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                    </button>
                </div>
            </div>

            <div id="sectionsContainer" class="sections-container">
                <p class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="saveMessage" class="save-message" style="display: none;"></div>
    </main>

    <script src="js/admin.js"></script>
    <script>
        // Require authentication
        requireAuth();

        let currentPage = 'home';
        let pageContent = {};
        let hasChanges = false;

        const pageTitles = {
            'home': 'Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
            'about': 'Ù…Ù† Ù†Ø­Ù†',
            'guide': 'Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨',
            'programs': 'Ø§Ù„ØªØ®ØµØµØ§Øª',
            'services': 'Ø§Ù„Ø®Ø¯Ù…Ø§Øª',
            'contact': 'Ø§Ù„ØªÙˆØ§ØµÙ„'
        };

        const pageUrls = {
            'home': '/',
            'about': '/about',
            'guide': '/guide',
            'programs': '/programs',
            'services': '/services',
            'contact': '/contact'
        };

        // Load initial page
        loadPageContent('home');

        function selectPage(pageName) {
            // Check for unsaved changes
            if (hasChanges) {
                if (!confirm('Ù„Ø¯ÙŠÙƒ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸ØŸ')) {
                    return;
                }
            }

            currentPage = pageName;
            hasChanges = false;

            // Update active tab
            document.querySelectorAll('.page-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            // Update title and preview link
            document.getElementById('currentPageTitle').textContent = `Ù…Ø­ØªÙˆÙ‰ ØµÙØ­Ø© ${pageTitles[pageName]}`;
            document.getElementById('previewLink').href = pageUrls[pageName];

            // Load content
            loadPageContent(pageName);
        }

        async function loadPageContent(pageName) {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '<p class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

            try {
                const response = await fetch(`/api/pages/${pageName}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    pageContent = data.data;
                    renderSections();
                } else {
                    container.innerHTML = '<p class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>';
                }
            } catch (error) {
                console.error('Error loading page content:', error);
                container.innerHTML = '<p class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</p>';
            }
        }

        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            const sections = Object.entries(pageContent);

            if (sections.length === 0) {
                container.innerHTML = '<p class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©</p>';
                return;
            }

            container.innerHTML = sections.map(([sectionId, section]) => `
                <div class="section-editor" data-section="${sectionId}">
                    <div class="section-header">
                        <h3>${escapeHtml(section.title || sectionId)}</h3>
                        <span class="section-id">${sectionId}</span>
                    </div>
                    <div class="section-body">
                        ${section.type === 'html' ? `
                            <textarea
                                class="section-content"
                                data-section="${sectionId}"
                                rows="4"
                                onchange="markChanged()"
                            >${escapeHtml(section.content)}</textarea>
                            <p class="hint">ÙŠØ¯Ø¹Ù… HTML Ù„Ù„ØªÙ†Ø³ÙŠÙ‚</p>
                        ` : `
                            <input
                                type="text"
                                class="section-content"
                                data-section="${sectionId}"
                                value="${escapeHtml(section.content)}"
                                onchange="markChanged()"
                            >
                        `}
                    </div>
                </div>
            `).join('');
        }

        function markChanged() {
            hasChanges = true;
        }

        async function saveAllChanges() {
            const sections = [];
            const inputs = document.querySelectorAll('.section-content');

            inputs.forEach(input => {
                const sectionId = input.dataset.section;
                sections.push({
                    section_id: sectionId,
                    content: input.value
                });
            });

            const messageDiv = document.getElementById('saveMessage');
            messageDiv.style.display = 'block';
            messageDiv.className = 'save-message loading';
            messageDiv.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

            try {
                const response = await fetch(`/api/pages/${currentPage}/bulk`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sections })
                });

                const data = await response.json();

                if (data.success) {
                    messageDiv.className = 'save-message success';
                    messageDiv.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!';
                    hasChanges = false;

                    // Hide message after 3 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 3000);
                } else {
                    messageDiv.className = 'save-message error';
                    messageDiv.textContent = data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª';
                }
            } catch (error) {
                console.error('Error saving changes:', error);
                messageDiv.className = 'save-message error';
                messageDiv.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
            }
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
