<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø© Ø§Ù„Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠÙŠÙ†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <p>Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø©</p>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item active">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            <a href="news.html" class="nav-item">
                <span class="nav-icon">ğŸ“°</span>
                <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
            </a>
            <a href="messages.html" class="nav-item">
                <span class="nav-icon">âœ‰ï¸</span>
                <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                <span id="unreadBadge" class="badge" style="display: none;">0</span>
            </a>
            <a href="memberships.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span>
            </a>
            <a href="pages.html" class="nav-item">
                <span class="nav-icon">ğŸ“„</span>
                <span>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª</span>
            </a>
            <a href="media.html" class="nav-item">
                <span class="nav-icon">ğŸ–¼ï¸</span>
                <span>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="/" class="nav-item">
                <span class="nav-icon">ğŸŒ</span>
                <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span>
            </a>
            <button onclick="logout()" class="nav-item logout-btn">
                <span class="nav-icon">ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆÙ‚Ø¹ Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø© Ø§Ù„Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠÙŠÙ† Ø¨Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</p>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“°</div>
                <div class="stat-info">
                    <h3 id="newsCount">0</h3>
                    <p>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">âœ‰ï¸</div>
                <div class="stat-info">
                    <h3 id="messagesCount">0</h3>
                    <p>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-info">
                    <h3 id="membershipsCount">0</h3>
                    <p>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ“„</div>
                <div class="stat-info">
                    <h3>7</h3>
                    <p>ØµÙØ­Ø§Øª</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <section class="dashboard-section">
            <h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
            <div class="quick-actions">
                <a href="news.html?action=new" class="action-card">
                    <span class="action-icon">â•</span>
                    <span>Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</span>
                </a>
                <a href="messages.html" class="action-card">
                    <span class="action-icon">ğŸ“¬</span>
                    <span>Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
                </a>
                <a href="pages.html" class="action-card">
                    <span class="action-icon">âœï¸</span>
                    <span>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</span>
                </a>
                <a href="memberships.html" class="action-card">
                    <span class="action-icon">ğŸ‘¤</span>
                    <span>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                </a>
            </div>
        </section>

        <!-- Recent Activity -->
        <div class="dashboard-grid">
            <!-- Recent News -->
            <section class="dashboard-section">
                <h2>Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
                <div id="recentNews" class="recent-list">
                    <p class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </section>

            <!-- Recent Messages -->
            <section class="dashboard-section">
                <h2>Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>
                <div id="recentMessages" class="recent-list">
                    <p class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </section>
        </div>

        <!-- Change Password Section -->
        <section class="dashboard-section">
            <h2>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <form id="changePasswordForm" class="password-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="currentPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="password" id="newPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <input type="password" id="confirmPassword" required minlength="6">
                    </div>
                </div>
                <div id="passwordError" class="error-message" style="display: none;"></div>
                <div id="passwordSuccess" class="success-message" style="display: none;"></div>
                <button type="submit" class="btn btn-primary">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
            </form>
        </section>
    </main>

    <script src="js/admin.js"></script>
    <script>
        // Require authentication
        requireAuth();

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load stats
                const [newsRes, messagesRes, membershipsRes] = await Promise.all([
                    fetch('/api/news/all', { credentials: 'include' }),
                    fetch('/api/messages', { credentials: 'include' }),
                    fetch('/api/memberships/stats', { credentials: 'include' })
                ]);

                const newsData = await newsRes.json();
                const messagesData = await messagesRes.json();
                const membershipsData = await membershipsRes.json();

                // Update stats
                if (newsData.success) {
                    document.getElementById('newsCount').textContent = newsData.data.length;
                }
                if (messagesData.success) {
                    document.getElementById('messagesCount').textContent = messagesData.data.length;
                    const unread = messagesData.data.filter(m => !m.is_read).length;
                    if (unread > 0) {
                        document.getElementById('unreadBadge').textContent = unread;
                        document.getElementById('unreadBadge').style.display = 'inline';
                    }
                }
                if (membershipsData.success) {
                    document.getElementById('membershipsCount').textContent = membershipsData.data.total;
                }

                // Load recent news
                const recentNewsDiv = document.getElementById('recentNews');
                if (newsData.success && newsData.data.length > 0) {
                    const recentNews = newsData.data.slice(0, 5);
                    recentNewsDiv.innerHTML = recentNews.map(news => `
                        <div class="recent-item">
                            <span class="recent-title">${news.title}</span>
                            <span class="recent-date">${formatDate(news.created_at)}</span>
                        </div>
                    `).join('');
                } else {
                    recentNewsDiv.innerHTML = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø±</p>';
                }

                // Load recent messages
                const recentMessagesDiv = document.getElementById('recentMessages');
                if (messagesData.success && messagesData.data.length > 0) {
                    const recentMessages = messagesData.data.slice(0, 5);
                    recentMessagesDiv.innerHTML = recentMessages.map(msg => `
                        <div class="recent-item ${!msg.is_read ? 'unread' : ''}">
                            <span class="recent-title">${msg.name} - ${msg.subject}</span>
                            <span class="recent-date">${formatDate(msg.created_at)}</span>
                        </div>
                    `).join('');
                } else {
                    recentMessagesDiv.innerHTML = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>';
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Handle password change
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                if (data.success) {
                    successDiv.textContent = 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­';
                    successDiv.style.display = 'block';
                    e.target.reset();
                } else {
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                errorDiv.style.display = 'block';
            }
        });

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
