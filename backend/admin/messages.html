<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <p>Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø©</p>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            <a href="news.html" class="nav-item">
                <span class="nav-icon">ğŸ“°</span>
                <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
            </a>
            <a href="messages.html" class="nav-item active">
                <span class="nav-icon">âœ‰ï¸</span>
                <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
            </a>
            <a href="memberships.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span>
            </a>
            <a href="pages.html" class="nav-item">
                <span class="nav-icon">ğŸ“„</span>
                <span>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª</span>
            </a>
            <a href="media.html" class="nav-item">
                <span class="nav-icon">ğŸ–¼ï¸</span>
                <span>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="/" class="nav-item">
                <span class="nav-icon">ğŸŒ</span>
                <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span>
            </a>
            <button onclick="logout()" class="nav-item logout-btn">
                <span class="nav-icon">ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-title">
                <h1>Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„</h1>
                <p>Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªÙˆØ§ØµÙ„</p>
            </div>
            <div class="header-stats">
                <span id="unreadCount" class="stat-badge">0 ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©</span>
            </div>
        </header>

        <!-- Messages List -->
        <div class="messages-container">
            <div id="messagesList" class="messages-list">
                <p class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <div id="messageDetail" class="message-detail" style="display: none;">
                <div class="message-detail-header">
                    <button onclick="closeMessageDetail()" class="btn-back">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                </div>
                <div id="messageContent" class="message-content">
                    <!-- Message content will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
                <button onclick="closeDeleteModal()" class="close-btn">&times;</button>
            </div>
            <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ</p>
            <p class="warning-text">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!</p>
            <div class="modal-actions">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="confirmDelete()" class="btn btn-danger">Ø­Ø°Ù</button>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // Require authentication
        requireAuth();

        let messageToDelete = null;
        let allMessages = [];

        // Load messages on page load
        loadMessages();

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages', { credentials: 'include' });
                const data = await response.json();

                const listDiv = document.getElementById('messagesList');

                if (data.success) {
                    allMessages = data.data;
                    const unreadCount = allMessages.filter(m => !m.is_read).length;
                    document.getElementById('unreadCount').textContent = `${unreadCount} ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©`;

                    if (allMessages.length > 0) {
                        listDiv.innerHTML = allMessages.map(msg => `
                            <div class="message-item ${!msg.is_read ? 'unread' : ''}" onclick="viewMessage(${msg.id})">
                                <div class="message-header">
                                    <span class="message-sender">${escapeHtml(msg.name)}</span>
                                    <span class="message-date">${formatDate(msg.created_at)}</span>
                                </div>
                                <div class="message-subject">${escapeHtml(msg.subject)}</div>
                                <div class="message-preview">${escapeHtml(msg.message.substring(0, 100))}...</div>
                                <div class="message-actions" onclick="event.stopPropagation()">
                                    <button onclick="toggleRead(${msg.id}, ${msg.is_read})" class="btn-icon" title="${msg.is_read ? 'ØªØ¹Ù„ÙŠÙ… ÙƒØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡' : 'ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡'}">
                                        ${msg.is_read ? 'ğŸ“¬' : 'ğŸ“­'}
                                    </button>
                                    <button onclick="deleteMessage(${msg.id})" class="btn-icon danger" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        listDiv.innerHTML = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML =
                    '<p class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>';
            }
        }

        async function viewMessage(id) {
            try {
                const response = await fetch(`/api/messages/${id}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    const msg = data.data;

                    // Mark as read
                    if (!msg.is_read) {
                        await fetch(`/api/messages/${id}/read`, {
                            method: 'PATCH',
                            credentials: 'include'
                        });
                    }

                    // Show message detail
                    document.getElementById('messagesList').style.display = 'none';
                    document.getElementById('messageDetail').style.display = 'block';

                    document.getElementById('messageContent').innerHTML = `
                        <div class="detail-header">
                            <h2>${escapeHtml(msg.subject)}</h2>
                            <span class="detail-date">${formatDate(msg.created_at)}</span>
                        </div>

                        <div class="detail-info">
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span>
                                <span class="info-value">${escapeHtml(msg.name)}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</span>
                                <span class="info-value">
                                    <a href="mailto:${escapeHtml(msg.email)}">${escapeHtml(msg.email)}</a>
                                </span>
                            </div>
                            ${msg.phone ? `
                            <div class="info-row">
                                <span class="info-label">Ø§Ù„Ù‡Ø§ØªÙ:</span>
                                <span class="info-value">
                                    <a href="tel:${escapeHtml(msg.phone)}">${escapeHtml(msg.phone)}</a>
                                </span>
                            </div>
                            ` : ''}
                        </div>

                        <div class="detail-body">
                            <h3>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</h3>
                            <p>${escapeHtml(msg.message).replace(/\n/g, '<br>')}</p>
                        </div>

                        <div class="detail-actions">
                            <a href="mailto:${escapeHtml(msg.email)}?subject=Re: ${encodeURIComponent(msg.subject)}" class="btn btn-primary">
                                Ø§Ù„Ø±Ø¯ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯
                            </a>
                            <button onclick="deleteMessage(${msg.id})" class="btn btn-danger">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</button>
                        </div>
                    `;

                    // Reload list to update read status
                    loadMessages();
                }
            } catch (error) {
                console.error('Error viewing message:', error);
            }
        }

        function closeMessageDetail() {
            document.getElementById('messageDetail').style.display = 'none';
            document.getElementById('messagesList').style.display = 'block';
        }

        async function toggleRead(id, isRead) {
            try {
                const endpoint = isRead ? 'unread' : 'read';
                await fetch(`/api/messages/${id}/${endpoint}`, {
                    method: 'PATCH',
                    credentials: 'include'
                });
                loadMessages();
            } catch (error) {
                console.error('Error toggling read status:', error);
            }
        }

        function deleteMessage(id) {
            messageToDelete = id;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            messageToDelete = null;
        }

        async function confirmDelete() {
            if (!messageToDelete) return;

            try {
                const response = await fetch(`/api/messages/${messageToDelete}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    closeDeleteModal();
                    closeMessageDetail();
                    loadMessages();
                }
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        }
    </script>
</body>
</html>
