<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูุฃุฎุจุงุฑ - ููุญุฉ ุงูุชุญูู</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>ููุญุฉ ุงูุชุญูู</h2>
            <p>ุงุชุญุงุฏ ุงูุทูุจุฉ</p>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">๐</span>
                <span>ุงูุฑุฆูุณูุฉ</span>
            </a>
            <a href="news.html" class="nav-item active">
                <span class="nav-icon">๐ฐ</span>
                <span>ุงูุฃุฎุจุงุฑ</span>
            </a>
            <a href="messages.html" class="nav-item">
                <span class="nav-icon">โ๏ธ</span>
                <span>ุงูุฑุณุงุฆู</span>
            </a>
            <a href="pages.html" class="nav-item">
                <span class="nav-icon">๐</span>
                <span>ูุญุชูู ุงูุตูุญุงุช</span>
            </a>
            <a href="media.html" class="nav-item">
                <span class="nav-icon">๐ผ๏ธ</span>
                <span>ุงููุณุงุฆุท</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="/" class="nav-item">
                <span class="nav-icon">๐</span>
                <span>ุงููููุน ุงูุฑุฆูุณู</span>
            </a>
            <button onclick="logout()" class="nav-item logout-btn">
                <span class="nav-icon">๐ช</span>
                <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-title">
                <h1>ุฅุฏุงุฑุฉ ุงูุฃุฎุจุงุฑ</h1>
                <p>ุฅุถุงูุฉ ูุชุนุฏูู ูุญุฐู ุงูุฃุฎุจุงุฑ ูุงูุฅุนูุงูุงุช</p>
            </div>
            <button onclick="showNewsModal()" class="btn btn-primary">
                <span>โ</span> ุฅุถุงูุฉ ุฎุจุฑ ุฌุฏูุฏ
            </button>
        </header>

        <!-- News List -->
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ุงูุนููุงู</th>
                        <th>ุงูุชุตููู</th>
                        <th>ุงูุญุงูุฉ</th>
                        <th>ุงูุชุงุฑูุฎ</th>
                        <th>ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody id="newsTableBody">
                    <tr>
                        <td colspan="5" class="loading">ุฌุงุฑู ุงูุชุญููู...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- News Modal -->
    <div id="newsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ุฅุถุงูุฉ ุฎุจุฑ ุฌุฏูุฏ</h2>
                <button onclick="closeNewsModal()" class="close-btn">&times;</button>
            </div>

            <form id="newsForm">
                <input type="hidden" id="newsId">

                <div class="form-group">
                    <label for="newsTitle">ุนููุงู ุงูุฎุจุฑ *</label>
                    <input type="text" id="newsTitle" required>
                </div>

                <div class="form-group">
                    <label for="newsContent">ุงููุญุชูู *</label>
                    <textarea id="newsContent" rows="6" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newsCategory">ุงูุชุตููู</label>
                        <select id="newsCategory">
                            <option value="news">ุฃุฎุจุงุฑ</option>
                            <option value="event">ูุนุงููุงุช</option>
                            <option value="announcement">ุฅุนูุงูุงุช</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="newsLocation">ุงูููุงู (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="newsLocation">
                    </div>
                </div>

                <div class="form-group">
                    <label>ุตูุฑุฉ ุงูุฎุจุฑ (ุงุฎุชูุงุฑู)</label>
                    <div class="upload-area" id="newsUploadArea" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; background: #f9fafb; margin-bottom: 0.5rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">๐ท</div>
                        <p style="color: #6b7280; margin: 0;">ุงุณุญุจ ุงูุตูุฑุฉ ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
                        <input type="file" id="newsImageFile" accept="image/*" style="display: none;">
                        <img id="newsImagePreview" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 1rem; display: none;">
                    </div>
                    <small style="color: #6b7280;">ุฃู ุฃุฏุฎู ุฑุงุจุท ุงูุตูุฑุฉ ูุจุงุดุฑุฉ:</small>
                    <input type="url" id="newsImage" placeholder="https://example.com/image.jpg" style="margin-top: 0.5rem;">
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="newsPublished" checked>
                        <span>ูุดุฑ ุงูุฎุจุฑ</span>
                    </label>
                </div>

                <div id="newsFormError" class="error-message" style="display: none;"></div>

                <div class="modal-actions">
                    <button type="button" onclick="closeNewsModal()" class="btn btn-secondary">ุฅูุบุงุก</button>
                    <button type="submit" class="btn btn-primary">ุญูุธ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>ุชุฃููุฏ ุงูุญุฐู</h2>
                <button onclick="closeDeleteModal()" class="close-btn">&times;</button>
            </div>
            <p>ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฎุจุฑุ</p>
            <p class="warning-text">ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!</p>
            <div class="modal-actions">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">ุฅูุบุงุก</button>
                <button onclick="confirmDelete()" class="btn btn-danger">ุญุฐู</button>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // Require authentication
        requireAuth();

        let newsToDelete = null;

        // Load news on page load
        loadNews();

        async function loadNews() {
            try {
                const response = await fetch('/api/news/all', { credentials: 'include' });
                const data = await response.json();

                const tbody = document.getElementById('newsTableBody');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(news => `
                        <tr>
                            <td>
                                <strong>${escapeHtml(news.title)}</strong>
                                <p class="subtitle">${escapeHtml(news.content.substring(0, 100))}...</p>
                            </td>
                            <td>
                                <span class="badge badge-${getCategoryClass(news.category)}">
                                    ${getCategoryLabel(news.category)}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${news.published ? 'published' : 'draft'}">
                                    ${news.published ? 'ููุดูุฑ' : 'ูุณูุฏุฉ'}
                                </span>
                            </td>
                            <td>${formatDate(news.created_at)}</td>
                            <td class="actions">
                                <button onclick="editNews(${news.id})" class="btn-icon" title="ุชุนุฏูู">โ๏ธ</button>
                                <button onclick="togglePublish(${news.id})" class="btn-icon" title="${news.published ? 'ุฅูุบุงุก ุงููุดุฑ' : 'ูุดุฑ'}">
                                    ${news.published ? '๐ค' : '๐ฅ'}
                                </button>
                                <button onclick="deleteNews(${news.id})" class="btn-icon danger" title="ุญุฐู">๐๏ธ</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty">ูุง ุชูุฌุฏ ุฃุฎุจุงุฑ</td></tr>';
                }
            } catch (error) {
                console.error('Error loading news:', error);
                document.getElementById('newsTableBody').innerHTML =
                    '<tr><td colspan="5" class="error">ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุงูุฃุฎุจุงุฑ</td></tr>';
            }
        }

        function getCategoryLabel(category) {
            const labels = {
                'news': 'ุฃุฎุจุงุฑ',
                'event': 'ูุนุงููุงุช',
                'announcement': 'ุฅุนูุงูุงุช'
            };
            return labels[category] || category;
        }

        function getCategoryClass(category) {
            const classes = {
                'news': 'primary',
                'event': 'success',
                'announcement': 'warning'
            };
            return classes[category] || 'primary';
        }

        function showNewsModal(newsData = null) {
            const modal = document.getElementById('newsModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('newsForm');
            const preview = document.getElementById('newsImagePreview');

            if (newsData) {
                title.textContent = 'ุชุนุฏูู ุงูุฎุจุฑ';
                document.getElementById('newsId').value = newsData.id;
                document.getElementById('newsTitle').value = newsData.title;
                document.getElementById('newsContent').value = newsData.content;
                document.getElementById('newsCategory').value = newsData.category;
                document.getElementById('newsLocation').value = newsData.location || '';
                document.getElementById('newsImage').value = newsData.image_url || '';
                document.getElementById('newsPublished').checked = newsData.published;

                // Show image preview if exists
                if (newsData.image_url) {
                    preview.src = newsData.image_url;
                    preview.style.display = 'block';
                } else {
                    preview.style.display = 'none';
                }
            } else {
                title.textContent = 'ุฅุถุงูุฉ ุฎุจุฑ ุฌุฏูุฏ';
                form.reset();
                document.getElementById('newsId').value = '';
                document.getElementById('newsPublished').checked = true;
                preview.style.display = 'none';
            }

            modal.style.display = 'flex';
        }

        function closeNewsModal() {
            document.getElementById('newsModal').style.display = 'none';
            document.getElementById('newsFormError').style.display = 'none';
        }

        async function editNews(id) {
            try {
                const response = await fetch(`/api/news/${id}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    showNewsModal(data.data);
                }
            } catch (error) {
                console.error('Error fetching news:', error);
            }
        }

        // Handle form submission
        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('newsId').value;
            const newsData = {
                title: document.getElementById('newsTitle').value,
                content: document.getElementById('newsContent').value,
                category: document.getElementById('newsCategory').value,
                location: document.getElementById('newsLocation').value || null,
                image_url: document.getElementById('newsImage').value || null,
                published: document.getElementById('newsPublished').checked ? 1 : 0
            };

            const errorDiv = document.getElementById('newsFormError');
            errorDiv.style.display = 'none';

            try {
                const url = id ? `/api/news/${id}` : '/api/news';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(newsData)
                });

                const data = await response.json();

                if (data.success) {
                    closeNewsModal();
                    loadNews();
                } else {
                    errorDiv.textContent = data.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'ุญุฏุซ ุฎุทุฃ ูู ุญูุธ ุงูุฎุจุฑ';
                errorDiv.style.display = 'block';
            }
        });

        async function togglePublish(id) {
            try {
                const response = await fetch(`/api/news/${id}/toggle-publish`, {
                    method: 'PATCH',
                    credentials: 'include'
                });

                if (response.ok) {
                    loadNews();
                }
            } catch (error) {
                console.error('Error toggling publish:', error);
            }
        }

        function deleteNews(id) {
            newsToDelete = id;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            newsToDelete = null;
        }

        async function confirmDelete() {
            if (!newsToDelete) return;

            try {
                const response = await fetch(`/api/news/${newsToDelete}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    closeDeleteModal();
                    loadNews();
                }
            } catch (error) {
                console.error('Error deleting news:', error);
            }
        }

        // Check for action parameter (e.g., ?action=new)
        if (new URLSearchParams(window.location.search).get('action') === 'new') {
            showNewsModal();
        }

        // ========================================
        // Image Upload for News
        // ========================================
        const newsUploadArea = document.getElementById('newsUploadArea');
        const newsImageFile = document.getElementById('newsImageFile');
        const newsImagePreview = document.getElementById('newsImagePreview');
        const newsImageInput = document.getElementById('newsImage');

        newsUploadArea.addEventListener('click', () => newsImageFile.click());

        newsUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            newsUploadArea.style.borderColor = '#006233';
            newsUploadArea.style.background = '#f0fdf4';
        });

        newsUploadArea.addEventListener('dragleave', () => {
            newsUploadArea.style.borderColor = '#d1d5db';
            newsUploadArea.style.background = '#f9fafb';
        });

        newsUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            newsUploadArea.style.borderColor = '#d1d5db';
            newsUploadArea.style.background = '#f9fafb';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                uploadNewsImage(file);
            }
        });

        newsImageFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadNewsImage(file);
            }
        });

        newsImageInput.addEventListener('input', (e) => {
            const url = e.target.value;
            if (url) {
                newsImagePreview.src = url;
                newsImagePreview.style.display = 'block';
            } else {
                newsImagePreview.style.display = 'none';
            }
        });

        async function uploadNewsImage(file) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/media/upload/news', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    newsImagePreview.src = data.data.url;
                    newsImagePreview.style.display = 'block';
                    newsImageInput.value = data.data.url;
                    alert('ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ');
                } else {
                    alert(data.message || 'ุฎุทุฃ ูู ุฑูุน ุงูุตูุฑุฉ');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('ุฎุทุฃ ูู ุฑูุน ุงูุตูุฑุฉ');
            }
        }
    </script>
</body>
</html>
