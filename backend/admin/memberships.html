<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <p>Ø§ØªØ­Ø§Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø©</p>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            <a href="news.html" class="nav-item">
                <span class="nav-icon">ğŸ“°</span>
                <span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
            </a>
            <a href="messages.html" class="nav-item">
                <span class="nav-icon">âœ‰ï¸</span>
                <span>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
            </a>
            <a href="memberships.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span>
            </a>
            <a href="pages.html" class="nav-item">
                <span class="nav-icon">ğŸ“„</span>
                <span>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª</span>
            </a>
            <a href="media.html" class="nav-item">
                <span class="nav-icon">ğŸ–¼ï¸</span>
                <span>Ø§Ù„ÙˆØ³Ø§Ø¦Ø·</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="/" class="nav-item">
                <span class="nav-icon">ğŸŒ</span>
                <span>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</span>
            </a>
            <button onclick="logout()" class="nav-item logout-btn">
                <span class="nav-icon">ğŸšª</span>
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="content-header">
            <div class="header-title">
                <h1>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h1>
                <p>Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø§ØªØ­Ø§Ø¯</p>
            </div>
        </header>

        <!-- Stats -->
        <div class="mini-stats">
            <div class="mini-stat">
                <span class="mini-stat-value" id="totalCount">0</span>
                <span class="mini-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
            </div>
            <div class="mini-stat pending">
                <span class="mini-stat-value" id="pendingCount">0</span>
                <span class="mini-stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
            </div>
            <div class="mini-stat approved">
                <span class="mini-stat-value" id="approvedCount">0</span>
                <span class="mini-stat-label">Ù…Ù‚Ø¨ÙˆÙ„</span>
            </div>
            <div class="mini-stat rejected">
                <span class="mini-stat-value" id="rejectedCount">0</span>
                <span class="mini-stat-label">Ù…Ø±ÙÙˆØ¶</span>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterMemberships('all')">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-tab" onclick="filterMemberships('pending')">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
            <button class="filter-tab" onclick="filterMemberships('approved')">Ù…Ù‚Ø¨ÙˆÙ„</button>
            <button class="filter-tab" onclick="filterMemberships('rejected')">Ù…Ø±ÙÙˆØ¶</button>
        </div>

        <!-- Memberships List -->
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</th>
                        <th>Ø§Ù„ØªØ®ØµØµ</th>
                        <th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="membershipsTableBody">
                    <tr>
                        <td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- View Details Modal -->
    <div id="detailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h2>
                <button onclick="closeDetailsModal()" class="close-btn">&times;</button>
            </div>
            <div id="membershipDetails" class="membership-details">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h2>
                <button onclick="closeDeleteModal()" class="close-btn">&times;</button>
            </div>
            <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
            <p class="warning-text">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!</p>
            <div class="modal-actions">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="confirmDelete()" class="btn btn-danger">Ø­Ø°Ù</button>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
    <script>
        // Require authentication
        requireAuth();

        let allMemberships = [];
        let currentFilter = 'all';
        let membershipToDelete = null;

        // Load on page load
        loadStats();
        loadMemberships();

        async function loadStats() {
            try {
                const response = await fetch('/api/memberships/stats', { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('totalCount').textContent = data.data.total;
                    document.getElementById('pendingCount').textContent = data.data.pending;
                    document.getElementById('approvedCount').textContent = data.data.approved;
                    document.getElementById('rejectedCount').textContent = data.data.rejected;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadMemberships() {
            try {
                const response = await fetch('/api/memberships', { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    allMemberships = data.data;
                    renderMemberships();
                }
            } catch (error) {
                console.error('Error loading memberships:', error);
                document.getElementById('membershipsTableBody').innerHTML =
                    '<tr><td colspan="7" class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</td></tr>';
            }
        }

        function filterMemberships(filter) {
            currentFilter = filter;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            renderMemberships();
        }

        function renderMemberships() {
            const tbody = document.getElementById('membershipsTableBody');
            let filtered = allMemberships;

            if (currentFilter !== 'all') {
                filtered = allMemberships.filter(m => m.status === currentFilter);
            }

            if (filtered.length > 0) {
                tbody.innerHTML = filtered.map(m => `
                    <tr>
                        <td>
                            <strong>${escapeHtml(m.full_name)}</strong>
                            <p class="subtitle">${escapeHtml(m.email)}</p>
                        </td>
                        <td>${escapeHtml(m.university)}</td>
                        <td>${escapeHtml(m.major)}</td>
                        <td>${escapeHtml(m.academic_level)}</td>
                        <td>
                            <span class="status-badge ${m.status}">
                                ${getStatusLabel(m.status)}
                            </span>
                        </td>
                        <td>${formatDate(m.created_at)}</td>
                        <td class="actions">
                            <button onclick="viewDetails(${m.id})" class="btn-icon" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">ğŸ‘ï¸</button>
                            ${m.status === 'pending' ? `
                                <button onclick="updateStatus(${m.id}, 'approved')" class="btn-icon success" title="Ù‚Ø¨ÙˆÙ„">âœ…</button>
                                <button onclick="updateStatus(${m.id}, 'rejected')" class="btn-icon danger" title="Ø±ÙØ¶">âŒ</button>
                            ` : ''}
                            <button onclick="deleteMembership(${m.id})" class="btn-icon danger" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
            }
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                'approved': 'Ù…Ù‚Ø¨ÙˆÙ„',
                'rejected': 'Ù…Ø±ÙÙˆØ¶'
            };
            return labels[status] || status;
        }

        async function viewDetails(id) {
            const membership = allMemberships.find(m => m.id === id);
            if (!membership) return;

            const detailsDiv = document.getElementById('membershipDetails');
            detailsDiv.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
                        <span class="detail-value">${escapeHtml(membership.full_name)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
                        <span class="detail-value">
                            <a href="mailto:${escapeHtml(membership.email)}">${escapeHtml(membership.email)}</a>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ù‡Ø§ØªÙ</span>
                        <span class="detail-value">
                            <a href="tel:${escapeHtml(membership.phone)}">${escapeHtml(membership.phone)}</a>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</span>
                        <span class="detail-value">${escapeHtml(membership.university)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„ØªØ®ØµØµ</span>
                        <span class="detail-value">${escapeHtml(membership.major)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ</span>
                        <span class="detail-value">${escapeHtml(membership.academic_level)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</span>
                        <span class="detail-value">${escapeHtml(membership.wilaya)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                        <span class="detail-value">
                            <span class="status-badge ${membership.status}">${getStatusLabel(membership.status)}</span>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</span>
                        <span class="detail-value">${formatDate(membership.created_at)}</span>
                    </div>
                </div>

                ${membership.status === 'pending' ? `
                <div class="detail-actions">
                    <button onclick="updateStatus(${membership.id}, 'approved'); closeDetailsModal();" class="btn btn-success">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                    <button onclick="updateStatus(${membership.id}, 'rejected'); closeDetailsModal();" class="btn btn-danger">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
                </div>
                ` : ''}
            `;

            document.getElementById('detailsModal').style.display = 'flex';
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        async function updateStatus(id, status) {
            try {
                const response = await fetch(`/api/memberships/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    loadStats();
                    loadMemberships();
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        function deleteMembership(id) {
            membershipToDelete = id;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            membershipToDelete = null;
        }

        async function confirmDelete() {
            if (!membershipToDelete) return;

            try {
                const response = await fetch(`/api/memberships/${membershipToDelete}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    closeDeleteModal();
                    loadStats();
                    loadMemberships();
                }
            } catch (error) {
                console.error('Error deleting membership:', error);
            }
        }
    </script>
</body>
</html>
